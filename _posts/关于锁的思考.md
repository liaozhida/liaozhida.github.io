关于锁的思考


锁是为了保证相同资源没有被同时修改

但是不能保证被重复执行

幂等是为了保证不被重复执行

所以  第一层应该是幂等
第二层才是锁

锁是为了避免，多个线程，一个共享的可变变量；

所以，如果只有一个资源，没有必要用锁，比如，方法A是改变一个指定账户的余额  ， 只要做了幂等就行 ；多个线程相同参数进来就被幂等拦截了， 但是要注意不能update对象，应该 + - 金额。 这样子  多个线程 不同金额参数进来，幂等及时无法拦截，+-也是正常的。**了解默认的锁机制**


对象锁，只是方法维度的对账户锁定，   要是跨多个方法，多个维度 ，怎么解决？

上层方法在变，只能在基础进行唯一性保证， 数据库锁：  selectForUpdate, 这样保证不同的业务再跑，都能锁定唯一的数据
加锁后，另一个对该行的更新会被阻塞，直至前一事务提交或回滚释放锁



selectForUpdate
- 场景1，订单改变状态，先 锁住，然后判断状态，再更新，所谓的 一锁二判三更新
- 场景2，用户余额，先selectforupdate 返回金额锁住，然后判断金额是否有变动，再更新


再有一个场景：

方法内 需要对A账户和B账户转账 
- select锁两个资源 
- 基本会计准则是要引入第三方的账户， A转C ， B转C ， 根据流水对C 定时修改，缓冲记账，要对fund-acct项目复盘一次

