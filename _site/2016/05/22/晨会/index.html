
<p>Netfilix 提供了一个比较好的解决方案，具体的应对措施包括：</p>

<p>网络超时：在等待响应时，不设置无限期阻塞，而是采用超时策略。使用超时策略可以确保资源不被无限期占用。</p>

<p>限制请求的次数：可以为客户端对某特定服务的请求设置一个访问上限。如果请求已达上限，就要立刻终止请求服务。</p>

<p>断路器模式（Circuit Breaker Pattern）：记录成功和失败 请求的数量。如果失效率超过一个阈值，触发断路器使得后续的请求立刻失败。如果大量的请求失败，就可能是这个服务不可用，再发请求也无意义。在一个失效期后，客户端可以再试，如果成功，关闭此断路器。</p>

<p>提供回滚：当一个请求失败后可以进行回滚逻辑。例如，返回缓存数据或者一个系统默认值。
Netflix Hystrix 是一个实现相关模式的开源库。如果使用 JVM，推荐使用Hystrix。而如果使用非 JVM 环境，你可以使用类似功能的库。</p>

<p>服务发现：</p>

<p>接口幂等性：</p>
<ul>
  <li>全局ID</li>
  <li>数据表索引</li>
  <li>版本控制</li>
  <li>引入中间状态
服务发现：
全局配置
@FeignClient使用
网络超时
限制请求的次数
断路器模式
提供回滚
zuul  路由Nginx  过滤器
事务</li>
</ul>

<p>全局配置</p>

<p>http://blog.daocloud.io/microservices-3/</p>

<p>负载均衡配置
@RibbonClient(name = “yea-ribbon”, configuration = YeaRibbonConfiguration.class)</p>

<p>postman的测试</p>

<p>Ribbon load balance algorithms</p>
<div class="highlighter-rouge"><pre class="highlight"><code>@Configuration
@RibbonClient(name = "foo", configuration = FooConfiguration.class)
public class TestConfiguration {
}

@Configuration
public class FooConfiguration {
    @Bean
    public IRule ribbonRule(IClientConfig config) {
        IRule rule = new RandomRule();
        rule.initWithNiwsConfig(config);
        return rule;
    }
}
</code></pre>
</div>

<p>mvn test 报错   忽略这个错误即可</p>
<div class="highlighter-rouge"><pre class="highlight"><code>BeanCreationNotAllowedException: Error creating bean with name 'org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientConfiguration': Singleton bean creation not allowed while singletons
</code></pre>
</div>

<p>HystrixCommand 表明该方法为hystrix包裹，可以对依赖服务进行隔离、降级、快速失败、快速重试等等hystrix相关功能 
该注解属性较多，下面讲解其中几个</p>

<p>fallbackMethod 降级方法
commandProperties 普通配置属性，可以配置HystrixCommand对应属性，例如采用线程池还是信号量隔离、熔断器熔断规则等等
ignoreExceptions 忽略的异常，默认HystrixBadRequestException不计入失败
groupKey() 组名称，默认使用类名称
commandKey 命令名称，默认使用方法名</p>

<p>@HystrixProperty(name = “hystrix.command.default.execution.timeout.enabled”, value = “false”)</p>

<p>Hystrix Dashboard</p>
<div class="highlighter-rouge"><pre class="highlight"><code>运行工程，可以访问 http://localhost:9090/hystrix.stream 获取dashboard信息，默认最大打开5个终端获取监控信息，可以增加delay参数指定获取监控数据间隔时间

直接访问hystrix.stream肯定是不明智的，官方提供监控hystrix-dashboard-#.#.#.war包,下载后放入tomcat中，


输入http://localhost:9090/hystrix.stream 点击 Monitor stream 进入Dashboard界面

访问 http://localhost:/9090/call 观察进入Dashboard变化 
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>@FeignClient(value = "routing", configuration = RoutingServiceConfiguration)
interface RoutingService {
    @RequestMapping(
            method = RequestMethod.GET,
            value = "/RoutingService/api/v1/Accounts/{id}"
    )
    Account account(@PathVariable("id") String id)
}
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>samplepong.ribbon.MaxAutoRetries=2
samplepong.ribbon.MaxAutoRetriesNextServer=2
samplepong.ribbon.OkToRetryOnAllOperations=true
samplepong.ribbon.ServerListRefreshInterval=2000
samplepong.ribbon.ConnectTimeout=5000
samplepong.ribbon.ReadTimeout=90000
samplepong.ribbon.EnableZoneAffinity=false
samplepong.ribbon.DeploymentContextBasedVipAddresses=sample-pong
samplepong.ribbon.NIWSServerListClassName=com.netflix.niws.loadbalancer.DiscoveryEnabledNIWSServerList
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>@Configuration
public class FeignConfiguration {
    @Value("${feign.connectTimeout:60000}")
    private int connectTimeout;

    @Value("${feign.readTimeOut:60000}")
    private int readTimeout;

    @Bean
    public Request.Options options() {
        return new Request.Options(connectTimeout, readTimeout);
    }
}
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>option 1: no new annotation.. just look at where it is.. (ex. a variable directly after '?' or '&amp;')

    @RequestLine("GET /domains/{domainId}/records?name={name}&amp;{extra}")
    Response recordsByNameAndType(@Param("domainId") int id, @Param("name") String nameFilter,
                                  @Param("extra") Map&lt;String, String&gt; options);
option 2: new annotation which splats on the end

    @RequestLine("GET /domains/{domainId}/records?name={name}")
    Response recordsByNameAndType(@Param("domainId") int id, @Param("name") String nameFilter,
                                  @QueryMap Map&lt;String, String&gt; options);
</code></pre>
</div>

<p>总结经验</p>

<ul>
  <li>Vo 迁移 ，上线后将 项目的 VO 迁移到model项目</li>
  <li>公共项目 稳健性 注释</li>
  <li>所有的方法需要返回值 对应的修改  //XXX ChangeReturn</li>
  <li>
    <p>接口命名 资源
```
@GetMapping(value=”/list”)
public Message&lt;PageListModelSecond<Ticket>&gt; getList(String userId, Integer pageIndex, Integer pageSize) {</Ticket></p>

    <p>return ticketService.getList(userId, pageIndex, pageSize);
}</p>
  </li>
</ul>

<p>@GetMapping(value=”/{userId}/stats”)
public Message&lt;Map&lt;String, String» userStats(@PathVariable(“userId”) String userId) {</p>

<div class="highlighter-rouge"><pre class="highlight"><code>return ticketService.userStats(userId); }    ``` - 参数的标记 非空，类型
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>@GetMapping(value = "/list")
    public Message&lt;PageListModelSecond&lt;Ticket&gt;&gt; getList(@RequestParam(value = "userId", required = true) String userId,
            Integer pageIndex, Integer pageSize) {
</code></pre>
</div>

<p>pom文件引入包</p>

<p>configClass</p>

<p>schema:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>http://www.springframework.org/schema/data/mongo/spring-mongo.xsd
</code></pre>
</div>

<p>yea-model拆分</p>

<p>/Users/zhidaliao/.m2/repository/com/netflix/ribbon/ribbon-loadbalancer/2.2.0/ribbon-loadbalancer-2.2.0.jar 
策略</p>

<p>自动重试  默认两次</p>

<p>Feign 和ribbon 结合， ribbon 的一些配置会失效，比如超时时间，feign 默认是五秒   ，但其他配置有些还是有用的  比如重试次数
  readTimeout: 15000</p>

<p>断路</p>
<div class="highlighter-rouge"><pre class="highlight"><code>java.lang.RuntimeException: Hystrix circuit short-circuited and is OPEN
</code></pre>
</div>

<p>fegin retry 默认两次 ??</p>

<p>超时异常</p>

<p>全局ID</p>

<p>Hystrix ：</p>

<p>Hystrix ：<br />
    熔断
    错误回滚</p>

<p>增加Pom.xml
http://localhost:8081/hystrix.stream  监控</p>

<p>ribbon 设置负载均衡  没有测试</p>

<div class="highlighter-rouge"><pre class="highlight"><code>@RibbonClient(name = "yea-ribbon", configuration = YeaRibbonConfiguration.class)

public class YeaRibbonConfiguration {
    
    @Autowired
    IClientConfig ribbonClientConfig;

    @Bean
    public IPing ribbonPing(IClientConfig config) {
        return new PingUrl();
    }

    @Bean
    public IRule ribbonRule(IClientConfig config) {
        return new AvailabilityFilteringRule();
    }
}

</code></pre>
</div>

<p>server:
  port: ${vcap.application.port:8081}</p>

<p>eureka:
  instance:
    leaseRenewalIntervalInSeconds: 1
    leaseExpirationDurationInSeconds: 2
  client:
    serviceUrl:
      defaultZone: ${vcap.services.eureka-service.credentials.uri:http://127.0.0.1:8761}/eureka/
  healthcheck:
    enabled: true
  lease:
    duration: 5</p>

<p>ribbon: 
  eureka:
    enabled: true
  connectTimeout: 8000
  readTimeout: 8000
  maxAutoRetries: 1</p>

<p>server:
  port: ${vcap.application.port:8081}</p>

<p>eureka:
  instance:
    leaseRenewalIntervalInSeconds: 1
    leaseExpirationDurationInSeconds: 2
  client:
    serviceUrl:
      defaultZone: ${vcap.services.eureka-service.credentials.uri:http://127.0.0.1:8761}/eureka/
  healthcheck:
    enabled: true
  lease:
    duration: 5</p>

<p>ribbon: 
  eureka:
    enabled: true
  connectTimeout: 8000
  readTimeout: 8000
  maxAutoRetries: 3</p>

<h1 id="max-number-of-retries-on-the-same-server-excluding-the-first-try">Max number of retries on the same server (excluding the first try)</h1>
<p>ribbon.maxAutoRetries = 1</p>

<h1 id="max-number-of-next-servers-to-retry-excluding-the-first-server">Max number of next servers to retry (excluding the first server)</h1>
<p>ribbon.MaxAutoRetriesNextServer = 2
3/ CONNECT TIMEOUT</p>

<p>From your logs it appears it takes about 1s to fail the connect attempt to the remote service. This very long for a stopped service. Attempts to connect to a TCP port with no service listening should fail immediately (at least if the host/ip is reachable and the connect attempt doesn’t end in the void)…</p>

<p>The connect timeout is controlled by the following property - make sure you set it to a descent value:</p>

<h1 id="connect-timeout-used-by-apache-httpclient">Connect timeout used by Apache HttpClient</h1>
<p>ribbon.ConnectTimeout=3000</p>

<h1 id="read-timeout-used-by-apache-httpclient">Read timeout used by Apache HttpClient</h1>
<p>ribbon.ReadTimeout=5000</p>

<p>PS: 
feign 默认会重试2次</p>

<p>MaxAutoRetriesNextServer  就不存在两次了？  研究一下</p>

<p>ribbon 也可以设置次数</p>

<p>结果就是叠加次数</p>

<p><a href="https://github.com/Netflix/Hystrix/wiki/Configuration#circuitBreaker.enabled">Hystrix Configuration</a>
<a href="https://github.com/Netflix/ribbon/blob/master/ribbon-examples/src/main/resources/sample-client.properties">Ribbon Configuration</a>
<a href="https://github.com/Netflix/ribbon/wiki/Working-with-load-balancers">Working with load balancers</a>
<a href="https://bushkarl.gitbooks.io/spring-cloud/content/spring_cloud_netflix/client_side_load_balancer_ribbon.html">spring cloud and ribbon client reference</a>
<a href="http://blog.didispace.com/springcloud3/">Spring Cloud构建微服务架构（三）断路器</a>
<a href="http://www.infocool.net/kb/Other/201704/339602.html">如何保证微服务接口的幂等性</a>
<a href="http://blog.brucefeng.info/post/api-idempotent">分布式系统接口幂等性</a></p>

